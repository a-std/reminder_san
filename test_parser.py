"""llm_parserのパターンマッチ・content抽出テスト"""

from datetime import datetime
from zoneinfo import ZoneInfo

from llm_parser import extract_content, parse_datetime_pattern

TZ = ZoneInfo("Asia/Tokyo")
# 基準: 2026/01/31 (土) 23:00
NOW = datetime(2026, 1, 31, 23, 0, tzinfo=TZ)


def run_tests():
    """全テストを実行"""
    failures = []
    total = 0

    # === 日時解析テスト ===
    datetime_tests = [
        # (入力, 期待する月/日 時:分)

        # --- 相対時間 ---
        ("30分後に買い物", "01/31 23:30"),
        ("1時間後にミーティング", "02/01 00:00"),
        ("2時間半後に出発", "02/01 01:30"),
        ("あと15分でご飯", "01/31 23:15"),
        ("あと3時間で映画", "02/01 02:00"),
        ("5分後にアラーム", "01/31 23:05"),
        ("10分後", "01/31 23:10"),
        ("あと1時間", "02/01 00:00"),
        ("45分後に出る", "01/31 23:45"),

        # --- 明日/明後日/しあさって ---
        ("明日の9時に歯医者", "02/01 09:00"),
        ("明日18時に飲み会", "02/01 18:00"),
        ("明日の朝ジョギング", "02/01 08:00"),
        ("明日の昼ランチ", "02/01 12:00"),
        ("明日の夜映画", "02/01 20:00"),
        ("明日昼の2時から電車", "02/01 14:00"),
        ("明日夜8時に歯医者", "02/01 20:00"),
        ("明日朝7時にジョギング", "02/01 07:00"),
        ("明日14時に会議", "02/01 14:00"),
        ("明日7時半に起床", "02/01 07:30"),
        ("明日10時15分に出発", "02/01 10:15"),
        ("明日の深夜に作業", "02/01 23:00"),
        ("明日の午後2時にお茶", "02/01 14:00"),
        ("明日の午前10時に病院", "02/01 10:00"),
        ("明日3時半に待ち合わせ", "02/01 03:30"),
        ("明後日の15時に面談", "02/02 15:00"),
        ("明後日の朝9時に出発", "02/02 09:00"),
        ("明後日の夜ご飯", "02/02 20:00"),
        ("しあさって9時に出社", "02/03 09:00"),
        ("明々後日の14時に面接", "02/03 14:00"),

        # --- 今日 ---
        # 23:00基準なのでdefault_hour=24(翌日扱い)
        ("今日の朝にメール", "01/31 08:00"),

        # --- 曜日 ---
        # 2026/01/31(土) 基準
        # 来週: 月=02/02, 火=02/03, 水=02/04, 木=02/05, 金=02/06, 土=02/07, 日=02/08
        ("来週の月曜10時に打ち合わせ", "02/02 10:00"),
        ("来週水曜の朝ミーティング", "02/04 08:00"),
        ("来週金曜18時に退社", "02/06 18:00"),
        ("来週の木曜日の夜飲み会", "02/05 20:00"),
        ("来週火曜の昼にランチ", "02/03 12:00"),
        ("次の金曜18時に飲み会", "02/06 18:00"),
        ("今度の火曜夜に食事", "02/03 20:00"),
        ("次の月曜朝8時に出勤", "02/02 08:00"),
        ("今度の日曜10時にサッカー", "02/01 10:00"),
        ("今週の土曜に掃除", "01/31 09:00"),

        # --- 日付指定 ---
        ("2月3日の10時に面接", "02/03 10:00"),
        ("2月14日の18時にディナー", "02/14 18:00"),
        ("3月1日の朝に出発", "03/01 08:00"),
        ("2月3日の昼2時から面接", "02/03 14:00"),
        ("12月25日の夜パーティー", "12/25 20:00"),
        ("4月1日の9時に入社式", "04/01 09:00"),
        ("2月28日の午後3時に卒業式", "02/28 15:00"),
        ("5月5日に子供の日", "05/05 09:00"),
        ("11月3日の朝にマラソン", "11/03 08:00"),
        ("7月20日の夜7時に花火", "07/20 19:00"),

        # --- 時刻のみ ---
        # 23:00基準なので翌日になる
        ("8時に起きる", "02/01 08:00"),
        ("午後3時に打ち合わせ", "02/01 15:00"),
        ("午前6時にランニング", "02/01 06:00"),
        ("正午にランチ", "02/01 12:00"),
        ("お昼にご飯", "02/01 12:00"),
        ("深夜に作業", "02/01 23:00"),
        ("15時半にお茶", "02/01 15:30"),
        ("9時45分に出社", "02/01 09:45"),
        ("夕方に買い物", "02/01 17:00"),
        ("朝イチでメール", "02/01 08:00"),

        # --- 週末 ---
        # 今日が土曜
        ("来週末に掃除", "02/07 09:00"),

        # --- 月末・月初 ---
        ("来月末にレポート", "02/28 09:00"),
        ("来月初に会議", "02/01 09:00"),
        ("来月末の18時に締め切り", "02/28 18:00"),
        ("来月初の朝にミーティング", "02/01 08:00"),

        # --- PM補正 ---
        ("明日昼3時に外出", "02/01 15:00"),
        ("明日夜7時に夕食", "02/01 19:00"),
        ("明日夜11時に就寝", "02/01 23:00"),
        ("2月5日の夕方5時に退社", "02/05 17:00"),
        ("明日朝6時に起床", "02/01 06:00"),
        ("明日昼1時にランチ", "02/01 13:00"),
        ("明日夜9時半に帰宅", "02/01 21:30"),
        ("明日夕方4時に迎え", "02/01 16:00"),
        ("明日朝11時に面談", "02/01 11:00"),
        # 12時はそのまま（PMコンテキストでも12+12=24にしない）
        ("明日昼12時にランチ", "02/01 12:00"),

        # --- 全角数字 ---
        ("明日１０時に会議", "02/01 10:00"),
        ("３０分後に出発", "01/31 23:30"),
        ("２月１４日の１８時にディナー", "02/14 18:00"),
    ]

    print("=== 日時解析テスト ===")
    for inp, expected in datetime_tests:
        total += 1
        dt = parse_datetime_pattern(inp, NOW, TZ)
        if dt is None:
            actual = "None"
        else:
            actual = dt.strftime("%m/%d %H:%M")
        if actual != expected:
            failures.append(f"  日時 NG: \"{inp}\" -> \"{actual}\" (expected \"{expected}\")")

    # === content抽出テスト ===
    content_tests = [
        # (入力, 期待するcontent)

        # --- 基本 ---
        ("明日の9時に歯医者", "歯医者"),
        ("明日18時に飲み会", "飲み会"),
        ("30分後に買い物", "買い物"),
        ("2時間半後に出発", "出発"),
        ("5分後にアラーム", "アラーム"),

        # --- 助詞「から」除去 ---
        ("明日の11時から電車", "電車"),
        ("明日昼の2時から電車", "電車"),
        ("今日の夕方から会議", "会議"),
        ("2月3日の昼2時から面接", "面接"),
        ("来週月曜の10時から打ち合わせ", "打ち合わせ"),

        # --- 助詞「まで」「までに」除去 ---
        ("来週の月曜までに資料作成", "資料作成"),
        ("明日の18時までにレポート", "レポート"),
        ("来月末までに引っ越し", "引っ越し"),

        # --- 助詞「で」除去 ---
        ("あと15分でご飯", "ご飯"),
        ("あと3時間で映画", "映画"),

        # --- 助詞「に」除去 ---
        ("明後日15時にミーティング", "ミーティング"),
        ("来月末にレポート提出", "レポート提出"),
        ("8時に起きる", "起きる"),

        # --- 助詞「の」除去（パターン内の「の」） ---
        ("今月初から出張", "出張"),

        # --- 助詞を食わないケース（重要） ---
        ("明日にんじん買う", "にんじん買う"),
        ("明日でんわする", "でんわする"),
        ("明日のりを買う", "のりを買う"),
        ("明日にがい薬を飲む", "にがい薬を飲む"),
        ("明日のんびりする", "のんびりする"),
        ("明日でかける", "でかける"),
        ("明日にこにこ笑う練習", "にこにこ笑う練習"),

        # --- 複合表現 ---
        ("明日の朝ゴミ出し", "ゴミ出し"),
        ("明日夜8時に歯医者", "歯医者"),
        ("来週水曜の朝ミーティング", "ミーティング"),
        ("2月14日の18時にディナー", "ディナー"),
        ("明後日の朝イチで出発", "出発"),
        ("来週末に大掃除", "大掃除"),
        ("正午にランチ", "ランチ"),

        # --- 長い内容 ---
        ("明日10時に田中さんとランチミーティング", "田中さんとランチミーティング"),
        ("来週月曜の朝チームの定例会議", "チームの定例会議"),
        ("3月1日の朝に東京駅で集合", "東京駅で集合"),
        ("明日の夜8時に渋谷で佐藤さんと食事", "渋谷で佐藤さんと食事"),
        ("来週金曜の18時から新宿で歓迎会", "新宿で歓迎会"),
        ("2月14日の夕方5時にプレゼント買う", "プレゼント買う"),

        # --- 全角数字 ---
        ("明日１０時に会議", "会議"),
        ("３０分後に出発", "出発"),
    ]

    print("=== content抽出テスト ===")
    for inp, expected in content_tests:
        total += 1
        actual = extract_content(inp)
        if actual != expected:
            failures.append(f"  内容 NG: \"{inp}\" -> \"{actual}\" (expected \"{expected}\")")

    # === 結果 ===
    passed = total - len(failures)
    print()
    if failures:
        for f in failures:
            print(f)
        print()
    print(f"{passed}/{total} passed")
    return len(failures) == 0


if __name__ == "__main__":
    import sys
    ok = run_tests()
    sys.exit(0 if ok else 1)
