"""llm_parserのパターンマッチ・content抽出テスト"""

from datetime import datetime
from zoneinfo import ZoneInfo

from llm_parser import extract_content, parse_datetime_pattern, parse_repeat_pattern

TZ = ZoneInfo("Asia/Tokyo")
# 基準: 2026/01/31 (土) 23:00
NOW = datetime(2026, 1, 31, 23, 0, tzinfo=TZ)


def run_tests():
    """全テストを実行"""
    failures = []
    total = 0

    # === 日時解析テスト ===
    datetime_tests = [
        # (入力, 期待する月/日 時:分)

        # --- 相対時間 ---
        ("30分後に買い物", "01/31 23:30"),
        ("1時間後にミーティング", "02/01 00:00"),
        ("2時間半後に出発", "02/01 01:30"),
        ("あと15分でご飯", "01/31 23:15"),
        ("あと3時間で映画", "02/01 02:00"),
        ("5分後にアラーム", "01/31 23:05"),
        ("10分後", "01/31 23:10"),
        ("あと1時間", "02/01 00:00"),
        ("45分後に出る", "01/31 23:45"),

        # --- 明日/明後日/しあさって ---
        ("明日の9時に歯医者", "02/01 09:00"),
        ("明日18時に飲み会", "02/01 18:00"),
        ("明日の朝ジョギング", "02/01 08:00"),
        ("明日の昼ランチ", "02/01 12:00"),
        ("明日の夜映画", "02/01 20:00"),
        ("明日昼の2時から電車", "02/01 14:00"),
        ("明日夜8時に歯医者", "02/01 20:00"),
        ("明日朝7時にジョギング", "02/01 07:00"),
        ("明日14時に会議", "02/01 14:00"),
        ("明日7時半に起床", "02/01 07:30"),
        ("明日10時15分に出発", "02/01 10:15"),
        # 深夜=23時。NOW=23:00ちょうどなので「<」により今日扱い
        ("明日の深夜に作業", "02/01 23:00"),
        ("明日の午後2時にお茶", "02/01 14:00"),
        ("明日の午前10時に病院", "02/01 10:00"),
        ("明日3時半に待ち合わせ", "02/01 03:30"),
        ("明後日の15時に面談", "02/02 15:00"),
        ("明後日の朝9時に出発", "02/02 09:00"),
        ("明後日の夜ご飯", "02/02 20:00"),
        ("しあさって9時に出社", "02/03 09:00"),
        ("明々後日の14時に面接", "02/03 14:00"),

        # --- 今日 ---
        # 23:00基準なのでdefault_hour=24(翌日扱い)
        ("今日の朝にメール", "01/31 08:00"),

        # --- 曜日 ---
        # 2026/01/31(土) 基準
        # 来週: 月=02/02, 火=02/03, 水=02/04, 木=02/05, 金=02/06, 土=02/07, 日=02/08
        ("来週の月曜10時に打ち合わせ", "02/02 10:00"),
        ("来週水曜の朝ミーティング", "02/04 08:00"),
        ("来週金曜18時に退社", "02/06 18:00"),
        ("来週の木曜日の夜飲み会", "02/05 20:00"),
        ("来週火曜の昼にランチ", "02/03 12:00"),
        ("次の金曜18時に飲み会", "02/06 18:00"),
        ("今度の火曜夜に食事", "02/03 20:00"),
        ("次の月曜朝8時に出勤", "02/02 08:00"),
        ("今度の日曜10時にサッカー", "02/01 10:00"),
        ("今週の土曜に掃除", "01/31 09:00"),

        # --- 日付指定 ---
        ("2月3日の10時に面接", "02/03 10:00"),
        ("2月14日の18時にディナー", "02/14 18:00"),
        ("3月1日の朝に出発", "03/01 08:00"),
        ("2月3日の昼2時から面接", "02/03 14:00"),
        ("12月25日の夜パーティー", "12/25 20:00"),
        ("4月1日の9時に入社式", "04/01 09:00"),
        ("2月28日の午後3時に卒業式", "02/28 15:00"),
        ("5月5日に子供の日", "05/05 09:00"),
        ("11月3日の朝にマラソン", "11/03 08:00"),
        ("7月20日の夜7時に花火", "07/20 19:00"),

        # --- 時刻のみ ---
        # 23:00基準なので翌日になる
        ("8時に起きる", "02/01 08:00"),
        ("午後3時に打ち合わせ", "02/01 15:00"),
        ("午前6時にランニング", "02/01 06:00"),
        ("正午にランチ", "02/01 12:00"),
        ("お昼にご飯", "02/01 12:00"),
        # NOW=23:00で深夜=23:00。ちょうど一致は今日扱い
        ("深夜に作業", "01/31 23:00"),
        ("15時半にお茶", "02/01 15:30"),
        ("9時45分に出社", "02/01 09:45"),
        ("夕方に買い物", "02/01 17:00"),
        ("朝イチでメール", "02/01 08:00"),

        # --- 週末 ---
        # 今日が土曜
        ("来週末に掃除", "02/07 09:00"),

        # --- 月末・月初 ---
        ("来月末にレポート", "02/28 09:00"),
        ("来月初に会議", "02/01 09:00"),
        ("来月末の18時に締め切り", "02/28 18:00"),
        ("来月初の朝にミーティング", "02/01 08:00"),

        # --- PM補正 ---
        ("明日昼3時に外出", "02/01 15:00"),
        ("明日夜7時に夕食", "02/01 19:00"),
        ("明日夜11時に就寝", "02/01 23:00"),
        ("2月5日の夕方5時に退社", "02/05 17:00"),
        ("明日朝6時に起床", "02/01 06:00"),
        ("明日昼1時にランチ", "02/01 13:00"),
        ("明日夜9時半に帰宅", "02/01 21:30"),
        ("明日夕方4時に迎え", "02/01 16:00"),
        ("明日朝11時に面談", "02/01 11:00"),
        # 12時はそのまま（PMコンテキストでも12+12=24にしない）
        ("明日昼12時にランチ", "02/01 12:00"),

        # --- X日後 / X週間後 ---
        ("3日後に出発", "02/03 09:00"),
        ("1日後に会議", "02/01 09:00"),
        ("7日後にレポート", "02/07 09:00"),
        ("あと5日で締め切り", "02/05 09:00"),
        ("2週間後にテスト", "02/14 09:00"),
        ("1週間後の18時に飲み会", "02/07 18:00"),

        # --- 今月X日 / 来月X日 / 再来月 ---
        # NOW=01/31(土) 23:00, 来月=2月, 再来月=3月
        ("今月31日の朝に掃除", "01/31 08:00"),
        ("来月10日の15時に歯医者", "02/10 15:00"),
        ("来月14日に買い物", "02/14 09:00"),
        ("再来月1日に会議", "03/01 09:00"),
        ("再来月15日の10時に面談", "03/15 10:00"),
        ("再来月末にレポート", "03/31 09:00"),
        ("再来月初に会議", "03/01 09:00"),

        # --- 全角数字 ---
        ("明日１０時に会議", "02/01 10:00"),
        ("３０分後に出発", "01/31 23:30"),
        ("２月１４日の１８時にディナー", "02/14 18:00"),
    ]

    print("=== 日時解析テスト ===")
    for inp, expected in datetime_tests:
        total += 1
        dt = parse_datetime_pattern(inp, NOW, TZ)
        if dt is None:
            actual = "None"
        else:
            actual = dt.strftime("%m/%d %H:%M")
        if actual != expected:
            failures.append(f"  日時 NG: \"{inp}\" -> \"{actual}\" (expected \"{expected}\")")

    # === content抽出テスト ===
    content_tests = [
        # (入力, 期待するcontent)

        # --- 基本 ---
        ("明日の9時に歯医者", "歯医者"),
        ("明日18時に飲み会", "飲み会"),
        ("30分後に買い物", "買い物"),
        ("2時間半後に出発", "出発"),
        ("5分後にアラーム", "アラーム"),

        # --- 助詞「から」除去（時刻あり）---
        ("明日の11時から電車", "電車"),
        ("明日昼の2時から電車", "電車"),
        ("今日の夕方から会議", "会議"),
        ("2月3日の昼2時から面接", "面接"),
        ("来週月曜の10時から打ち合わせ", "打ち合わせ"),

        # --- 助詞「から」除去（日付のみ・時刻なし）---
        ("明日から電車", "電車"),
        ("明日のから電車", "電車"),
        ("今日から試験", "試験"),
        ("今日のから試験", "試験"),
        ("明後日から旅行", "旅行"),
        ("明後日のから出張", "出張"),

        # --- 二重助詞「のから」除去（時刻あり）---
        ("朝のから電車", "電車"),
        ("夕方のから会議", "会議"),
        ("明日の朝のから出発", "出発"),

        # --- 助詞「まで」「までに」除去 ---
        ("来週の月曜までに資料作成", "資料作成"),
        ("明日の18時までにレポート", "レポート"),
        ("来月末までに引っ越し", "引っ越し"),
        ("明日まで仕事", "仕事"),
        ("明日までに提出", "提出"),
        ("明日のまでに宿題", "宿題"),

        # --- 助詞「で」除去 ---
        ("あと15分でご飯", "ご飯"),
        ("あと3時間で映画", "映画"),
        ("明日で締め切り", "締め切り"),

        # --- 助詞「に」除去 ---
        ("明後日15時にミーティング", "ミーティング"),
        ("来月末にレポート提出", "レポート提出"),
        ("8時に起きる", "起きる"),
        ("明日に会議", "会議"),

        # --- 助詞「の」除去（パターン内の「の」） ---
        ("今月初から出張", "出張"),

        # --- 複合語を食わないケース（重要） ---
        ("明日にんじん買う", "にんじん買う"),
        ("明日でんわする", "でんわする"),
        ("明日のりを買う", "のりを買う"),
        ("明日にがい薬を飲む", "にがい薬を飲む"),
        ("明日のんびりする", "のんびりする"),
        ("明日でかける", "でかける"),
        ("明日にこにこ笑う練習", "にこにこ笑う練習"),
        ("明日から揚げ", "から揚げ"),
        ("明日のから揚げ", "から揚げ"),
        ("明日からし買う", "からし買う"),
        ("明日できる", "できる"),
        ("5分後のから揚げ", "から揚げ"),
        ("朝のから揚げ弁当", "から揚げ弁当"),

        # --- 複合表現 ---
        ("明日の朝ゴミ出し", "ゴミ出し"),
        ("明日夜8時に歯医者", "歯医者"),
        ("来週水曜の朝ミーティング", "ミーティング"),
        ("2月14日の18時にディナー", "ディナー"),
        ("明後日の朝イチで出発", "出発"),
        ("来週末に大掃除", "大掃除"),
        ("正午にランチ", "ランチ"),

        # --- 長い内容 ---
        ("明日10時に田中さんとランチミーティング", "田中さんとランチミーティング"),
        ("来週月曜の朝チームの定例会議", "チームの定例会議"),
        ("3月1日の朝に東京駅で集合", "東京駅で集合"),
        ("明日の夜8時に渋谷で佐藤さんと食事", "渋谷で佐藤さんと食事"),
        ("来週金曜の18時から新宿で歓迎会", "新宿で歓迎会"),
        ("2月14日の夕方5時にプレゼント買う", "プレゼント買う"),

        # --- X日後 / X週間後 ---
        ("3日後に出発", "出発"),
        ("あと5日で締め切り", "締め切り"),
        ("2週間後にテスト", "テスト"),
        ("1週間後の18時に飲み会", "飲み会"),

        # --- 今月/来月/再来月 ---
        ("来月10日の15時に歯医者", "歯医者"),
        ("再来月1日に会議", "会議"),
        ("再来月末にレポート", "レポート"),

        # --- 全角数字 ---
        ("明日１０時に会議", "会議"),
        ("３０分後に出発", "出発"),
    ]

    print("=== content抽出テスト ===")
    for inp, expected in content_tests:
        total += 1
        actual = extract_content(inp)
        if actual != expected:
            failures.append(f"  内容 NG: \"{inp}\" -> \"{actual}\" (expected \"{expected}\")")

    # === 繰り返しパターンテスト ===
    # NOW = 2026/01/31 (土) 23:00
    repeat_tests = [
        # (入力, repeat_type, repeat_value, 期待する月/日 時:分)

        # --- 毎日 ---
        ("毎日18時にゴミ出し", "daily", None, "02/01 18:00"),
        ("毎日9時に朝礼", "daily", None, "02/01 09:00"),
        ("毎日の15時半に休憩", "daily", None, "02/01 15:30"),

        # --- 毎朝 ---
        ("毎朝ジョギング", "daily", None, "02/01 08:00"),
        ("毎朝7時にラジオ体操", "daily", None, "02/01 07:00"),

        # --- 毎晩 ---
        ("毎晩ストレッチ", "daily", None, "02/01 20:00"),
        ("毎晩22時に日記", "daily", None, "02/01 22:00"),

        # --- 毎夕 ---
        ("毎夕方に散歩", "daily", None, "02/01 17:00"),
        ("毎夕に買い物", "daily", None, "02/01 17:00"),

        # --- 毎週X曜 ---
        ("毎週月曜9時に会議", "weekly", "月", "02/02 09:00"),
        ("毎週金曜の18時に飲み会", "weekly", "金", "02/06 18:00"),
        ("毎週水曜にミーティング", "weekly", "水", "02/04 09:00"),
        ("毎週日曜10時にサッカー", "weekly", "日", "02/01 10:00"),

        # --- 毎週（曜日なし）→ 今日（土曜）の曜日 ---
        ("毎週ミーティング", "weekly", "土", "02/07 09:00"),

        # --- 毎月第N X曜日 ---
        # 2026/02 第1月曜=02/02, 第2月曜=02/09, 第3金曜=02/20
        ("毎月第1月曜に朝会", "monthly", "第1月", "02/02 09:00"),
        ("毎月第2月曜10時にレビュー", "monthly", "第2月", "02/09 10:00"),
        ("毎月第3金曜日に締め会", "monthly", "第3金", "02/20 09:00"),
        ("毎月第1水曜の15時に定例", "monthly", "第1水", "02/04 15:00"),

        # --- 毎月第N X曜日の前日 ---
        # 第2月曜=02/09 → 前日=02/08
        ("毎月第2月曜の前日に準備", "monthly", "第2月の前日", "02/08 09:00"),
        ("毎月第1金曜日の前日に資料作成", "monthly", "第1金の前日", "02/05 09:00"),
        ("毎月第3水曜の前日18時にリマインド", "monthly", "第3水の前日", "02/17 18:00"),

        # --- 毎月第N,N X曜日（複数指定）---
        # 2026/02 第1水曜=02/04, 第3水曜=02/18 → 前日=02/03, 02/17
        ("毎月第1,3水曜の前日の20時にゴミ出し", "monthly", "第1,3水の前日", "02/03 20:00"),
        ("毎月第1、3水曜の前日の20時にゴミ出し", "monthly", "第1,3水の前日", "02/03 20:00"),
        ("毎月第2,4金曜に定例", "monthly", "第2,4金", "02/13 09:00"),

        # --- 毎月X日 ---
        ("毎月1日に家賃", "monthly", "1", "02/01 09:00"),
        ("毎月15日に給料日", "monthly", "15", "02/15 09:00"),
        ("毎月25日の18時に支払い", "monthly", "25", "02/25 18:00"),

        # --- 平日 ---
        ("平日の9時に朝会", "weekdays", None, "02/02 09:00"),
        ("平日8時半に出勤", "weekdays", None, "02/02 08:30"),

        # --- 隔週 ---
        ("隔週火曜に定例", "biweekly", "火", "02/03 09:00"),
        ("隔週月曜10時にレビュー", "biweekly", "月", "02/02 10:00"),
    ]

    print("=== 繰り返しパターンテスト ===")
    for test in repeat_tests:
        inp, exp_type, exp_value, exp_dt = test
        total += 1
        result = parse_repeat_pattern(inp, NOW, TZ)
        if result is None:
            failures.append(f"  繰返 NG: \"{inp}\" -> None (expected type={exp_type})")
            continue
        actual_type = result["repeat_type"]
        actual_value = result.get("repeat_value")
        actual_dt = result["remind_at"].strftime("%m/%d %H:%M")
        if actual_type != exp_type:
            failures.append(f"  繰返 NG: \"{inp}\" type=\"{actual_type}\" (expected \"{exp_type}\")")
        if actual_value != exp_value:
            failures.append(f"  繰返 NG: \"{inp}\" value=\"{actual_value}\" (expected \"{exp_value}\")")
        if actual_dt != exp_dt:
            failures.append(f"  繰返 NG: \"{inp}\" dt=\"{actual_dt}\" (expected \"{exp_dt}\")")

    # === 繰り返しのcontent抽出テスト ===
    repeat_content_tests = [
        ("毎日18時にゴミ出し", "ゴミ出し"),
        ("毎朝ジョギング", "ジョギング"),
        ("毎晩ストレッチ", "ストレッチ"),
        ("毎週月曜9時に会議", "会議"),
        ("毎月1日に家賃", "家賃"),
        ("平日の9時に朝会", "朝会"),
        ("隔週火曜に定例", "定例"),
        ("毎夕方に散歩", "散歩"),
        ("毎週ミーティング", "ミーティング"),
        ("毎月25日の18時に支払い", "支払い"),
        ("毎月第2月曜10時にレビュー", "レビュー"),
        ("毎月第2月曜の前日に準備", "準備"),
        ("毎月第3水曜の前日18時にリマインド", "リマインド"),
        ("毎月第1,3水曜の前日の20時にゴミ出し", "ゴミ出し"),
        ("毎月第2,4金曜に定例", "定例"),
    ]

    print("=== 繰り返しcontent抽出テスト ===")
    for inp, expected in repeat_content_tests:
        total += 1
        actual = extract_content(inp)
        if actual != expected:
            failures.append(f"  繰内 NG: \"{inp}\" -> \"{actual}\" (expected \"{expected}\")")

    # === 結果 ===
    passed = total - len(failures)
    print()
    if failures:
        for f in failures:
            print(f)
        print()
    print(f"{passed}/{total} passed")
    return len(failures) == 0


if __name__ == "__main__":
    import sys
    ok = run_tests()
    sys.exit(0 if ok else 1)
